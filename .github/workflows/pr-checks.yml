name: PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-title-check:
    runs-on: ubuntu-latest
    steps:
    - name: Check PR title format
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          test
          chore
        requireScope: false
        ignoreLabels: |
          ignore-semantic-pull-request

  test-coverage-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install uv
        uv pip install --system -e ".[test]"
    
    - name: Run tests and check coverage
      id: coverage
      run: |
        pytest --cov=. --cov-report=xml --cov-report=term-missing --cov-fail-under=70 | tee pytest_output.txt
        COVERAGE=$(grep "TOTAL" pytest_output.txt | awk '{print $4}' | sed 's/%//')
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
    
    - name: Coverage Badge
      uses: tj-actions/coverage-badge-py@v2
      with:
        output: coverage.svg
    
    - name: Comment PR with coverage results
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        header: coverage
        message: |
          ## ğŸ“Š Coverage Report
          
          **Current Coverage:** ${{ steps.coverage.outputs.coverage }}%
          
          The minimum required coverage is **70%**.
          
          ${{ steps.coverage.outputs.coverage >= 70 && 'âœ… Coverage requirement met!' || 'âŒ Coverage requirement not met!' }}

  dependency-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: Check for security vulnerabilities
      run: |
        python -m pip install --upgrade pip
        pip install safety
        safety check --json --output safety-report.json || echo "Security issues found"
        safety check || echo "Please review security report"

  code-quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: Install quality tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort complexity-check
    
    - name: Check code complexity
      run: |
        # Check for complex functions (complexity > 10)
        python -m mccabe --min 10 . || echo "Complex functions found - consider refactoring"
    
    - name: Run code quality checks
      run: |
        echo "ğŸ” Running code quality analysis..."
        
        # Count lines of code
        echo "ğŸ“ Lines of code:"
        find . -name "*.py" -not -path "./tests/*" -not -path "./.venv/*" | xargs wc -l | tail -1
        
        # Check for TODO/FIXME comments
        echo "ğŸ“ TODO/FIXME comments:"
        grep -r "TODO\|FIXME" --include="*.py" . || echo "No TODO/FIXME comments found"
        
        # Check test coverage of new files
        echo "ğŸ”¬ Checking if new files have corresponding tests..."
        git diff --name-only origin/main...HEAD | grep "\.py$" | grep -v test_ | while read file; do
          if [ -f "$file" ]; then
            test_file="tests/test_$(basename "$file")"
            if [ ! -f "$test_file" ]; then
              echo "âš ï¸ Warning: $file may need a corresponding test file at $test_file"
            fi
          fi
        done